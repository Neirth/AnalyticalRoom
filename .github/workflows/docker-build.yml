name: Build and Publish Docker Images

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**.rs'
      - 'packages/**/.docker/Dockerfile'

  workflow_dispatch:
    inputs:
      package:
        description: 'Specific package to build (optional)'
        required: false
        type: string
      tag:
        description: 'Custom tag for the image'
        required: false
        type: string
        default: 'latest'

env:
  REGISTRY: ghcr.io
  OWNER: neirth

jobs:
  detect-packages:
    name: Detect packages with Docker support
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.detect.outputs.packages }}
      packages-json: ${{ steps.detect.outputs.packages-json }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect packages with Dockerfiles
        id: detect
        run: |
          echo "ðŸ” Detecting packages with Docker support..."

          packages=()
          packages_json="["

          for package_dir in packages/*/; do
            if [ -d "$package_dir" ]; then
              package_name=$(basename "$package_dir")
              dockerfile_path="$package_dir.docker/Dockerfile"

              if [ -f "$dockerfile_path" ]; then
                echo "âœ… Found package with Docker support: $package_name"
                packages+=("$package_name")

                # Add to JSON array
                if [ ${#packages[@]} -gt 1 ]; then
                  packages_json+=","
                fi
                packages_json+="\"$package_name\""
              else
                echo "â­ï¸  Skipping $package_name (no Dockerfile found)"
              fi
            fi
          done

          packages_json+="]"

          echo "ðŸ“¦ Detected packages: ${packages[*]}"
          echo "packages=${packages[*]}" >> $GITHUB_OUTPUT
          echo "packages-json=$packages_json" >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.package }} [${{ matrix.arch }}]
    needs: detect-packages
    runs-on: ${{ matrix.runner }}
    if: needs.detect-packages.outputs.packages != ''
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-packages.outputs.packages-json) }}
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event.inputs.tag != '' }}
          labels: |
            org.opencontainers.image.title=${{ matrix.package }}
            org.opencontainers.image.description=AnalyticalRoom ${{ matrix.package }} package
            org.opencontainers.image.vendor=Neirth
            org.opencontainers.image.source=https://github.com/Neirth/AnalyticalRoom

      - name: Check if package should be built
        id: should-build
        run: |
          # If specific package is requested via workflow_dispatch, only build that package
          if [ "${{ github.event.inputs.package }}" != "" ]; then
            if [ "${{ github.event.inputs.package }}" = "${{ matrix.package }}" ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Building requested package: ${{ matrix.package }}"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  Skipping ${{ matrix.package }} (not requested)"
            fi
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Building package: ${{ matrix.package }}"
          fi

      - name: Build and push Docker image
        if: steps.should-build.outputs.should_build == 'true'
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/${{ matrix.package }}/.docker/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:${{ github.sha }}-${{ matrix.arch }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:latest-${{ matrix.arch }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-manifest:
    runs-on: ubuntu-latest
    needs: [detect-packages, build]
    if: needs.detect-packages.outputs.packages != ''
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-packages.outputs.packages-json) }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if package should be processed
        id: should-process
        run: |
          # If specific package is requested via workflow_dispatch, only process that package
          if [ "${{ github.event.inputs.package }}" != "" ]; then
            if [ "${{ github.event.inputs.package }}" = "${{ matrix.package }}" ]; then
              echo "should_process=true" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Processing requested package: ${{ matrix.package }}"
            else
              echo "should_process=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  Skipping ${{ matrix.package }} (not requested)"
            fi
          else
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Processing package: ${{ matrix.package }}"
          fi

      - name: Create and push multi-arch manifest
        if: steps.should-process.outputs.should_process == 'true'
        run: |
          echo "ðŸ”— Creating multi-arch manifest for ${{ matrix.package }}"

          # Determine the tag to use
          if [ "${{ github.ref_type }}" = "tag" ]; then
            final_tag="${{ github.ref_name }}"
          elif [ "${{ github.event.inputs.tag }}" != "" ]; then
            final_tag="${{ github.event.inputs.tag }}"
          else
            final_tag="latest"
          fi

          echo "ðŸ“‹ Final tag will be: $final_tag"

          # Create multi-arch manifest using buildx imagetools
          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:${final_tag} \
            --tag ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:${{ github.sha }} \
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:${{ github.sha }}-amd64 \
            ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:${{ github.sha }}-arm64

          echo "âœ… Multi-arch manifest created successfully for ${{ matrix.package }}:${final_tag}"
        
  test-images:
    name: Test Docker Images
    runs-on: ubuntu-latest
    needs: [detect-packages, publish-manifest]
    if: needs.detect-packages.outputs.packages != ''
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-packages.outputs.packages-json) }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test Docker image
        run: |
          echo "ðŸ§ª Testing multi-arch Docker image for ${{ matrix.package }}"

          # Determine the tag to test
          if [ "${{ github.ref_type }}" = "tag" ]; then
            tag="${{ github.ref_name }}"
          elif [ "${{ github.event.inputs.tag }}" != "" ]; then
            tag="${{ github.event.inputs.tag }}"
          else
            tag="latest"
          fi

          image="${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:${tag}"

          echo "ðŸ“¥ Pulling multi-arch image: $image"
          docker pull "$image"

          echo "ðŸ” Inspecting multi-arch manifest..."
          docker buildx imagetools inspect "$image"

          echo "ðŸ” Inspecting local image..."
          docker inspect "$image"

          echo "ðŸ“‹ Image layers:"
          docker history "$image" --no-trunc

          echo "âœ… Multi-arch image test completed for ${{ matrix.package }}"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [detect-packages, publish-manifest]
    if: needs.detect-packages.outputs.packages != ''
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-packages.outputs.packages-json) }}

    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.package }}:latest
          format: sarif
          output: trivy-results-${{ matrix.package }}.sarif

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results-${{ matrix.package }}.sarif
          category: trivy-${{ matrix.package }}

  deploy-into-infra:
    name: Deploy into Infrastructure
    runs-on: ubuntu-latest
    environment: production

    needs: [detect-packages, publish-manifest, test-images, security-scan]
    if: needs.detect-packages.outputs.packages != ''

    steps:
      - name: Deploy to production 'deep_analytics'
        uses: johnbeynon/render-deploy-action@v0.0.8
        if: contains(needs.detect-packages.outputs.packages, 'deep_analytics')
        with:
          service-id: ${{ secrets.DEEP_ANALYTICS_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

      - name: Deploy to production 'logical_engine'
        uses: johnbeynon/render-deploy-action@v0.0.8
        if: contains(needs.detect-packages.outputs.packages, 'logical_engine')
        with:
          service-id: ${{ secrets.LOGICAL_ENGINE_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

  deployment-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    needs: [detect-packages, publish-manifest, test-images]
    if: needs.detect-packages.outputs.packages != ''

    steps:
      - name: Generate deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Packages" >> $GITHUB_STEP_SUMMARY

          packages="${{ needs.detect-packages.outputs.packages }}"
          for package in $packages; do
            echo "- **$package**: \`${{ env.REGISTRY }}/${{ env.OWNER }}/$package:latest\`" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Usage Examples" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for package in $packages; do
            echo "#### $package" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Pull the image" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.OWNER }}/$package:latest" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Run the container" >> $GITHUB_STEP_SUMMARY
            echo "docker run -p 8080:8080 ${{ env.REGISTRY }}/${{ env.OWNER }}/$package:latest" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "### ðŸ“‹ Registry Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: GitHub Container Registry (\`ghcr.io\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: \`${{ env.OWNER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Visibility**: Package visibility follows repository settings" >> $GITHUB_STEP_SUMMARY
          echo "- **Architectures**: \`linux/amd64\`, \`linux/arm64\`" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Packages](${{ github.server_url }}/${{ github.repository }}/pkgs/container)" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY